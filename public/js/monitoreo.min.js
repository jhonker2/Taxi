var socket = io.connect('http://127.0.0.1:8010');
var id='1';
var aux2 =0;
var _ID=null;
var MARCADORES=[];
var markerpuntos;
var MOVIL = [];
var vacio="'todos'";
var tex= "'Todos los empleados'";
var MAP=null; 
var lineas=null;
var lineas_2=null;
var li="",li2='',cont=0;
var stack_bottomleft = {"dir1": "up", "dir2": "left", "firstpos1": 25, "firstpos2": 25};
var gps_latitud=0.0,gps_longitud=0.0;
var markers = [];
var colorArray = [];
var CuadrillaArray=[];
var numero_telefono;
var TramitesArray = [];
$(document).ready(function(){
	colores();
});



var con_t=0, con2_t=0, tramitecont=0, tramitecont_a=0, con2_t_a=0, con3_t=0, tra_con=0,pos_A=0;

	var con_a=0,con=0, con2=0,con2_a=0, con3=0;
	socket.emit("recibirDatos", id);
	socket.on("usuarios_not", function (data){
	$.each(data.cata2, function(index, user){
		debugger
		console.log(user.nombre+"-"+user.estado);
		if(user.col !="LECTOR"){
  		idmovil="'"+user.cedula+"'";
  		nombre ="'"+user.nombre+"'";
  			var index2=buscar_cuadrilla(user.cedula);
  			if(index2===-1){//NO ENCONTRADO
  				CuadrillaArray.push({cedula:user.cedula,mark:colorArray[index].color});
		    }
			if(user.estado=="offline"){
				con=0;
		  		li+='<a data-toggle="tooltip" data-placement="right" title="Sin conexión" id="Listempleado" href="javascript:void(0)" class="list-group-item disabled cuadrilla-text"><img class="icon-line" src="img/offline.png"> '+user.nombre+' <img class="icon-line" src="img/'+colorArray[index].color+'.png"></a>';
		  		var index=buscar_idmovil(user.nombre);
					if(index!==-1){//ENCONTRADO
						removerPosicion(index);
					}
			}else if(user.estado=="online"){
				con2++;
		  		li+='<a data-toggle="tooltip" data-placement="right" title="En linea" id="Listempleado" href="javascript:Empleado('+idmovil+','+nombre+')"class="list-group-item cuadrilla-text"><img class="icon-line" src="img/online.png">  '+user.nombre+' <img class="icon-line" src="img/'+colorArray[index].color+'.png"></a>';
		  		con++;
			}
		}
	});

	li2="";
  	li2+='<a href="javascript:Empleado('+vacio+','+tex+')" class="list-group-item"><img class="icon-line" src="img/online.png"> Todas las cuadrillas</a>';
  	li2+=li;
  	if(con_a!=con){
  		$("#listUsuarios").html("");
  		$("#listUsuarios").html(li2);
  		if(con2!=0){	
  			if(con2_a<con2){
  				con3=con2-con2_a;
  				if(con3 >1){
  					$("#audio")[0].play();
  				}else{
  					$("#audio")[0].play();
  				}
  			}

  		}
  	}else if(con_a==0){
  		$("#listUsuarios").html(li2);
  	}
  	li=""; con_a=con; con2_a =con2; con2=0;con3=0;
});



socket.on('notification', function (data) {
	eliminarMarcadores();
	if(data.cata==""){
		//$("#listUsuarios").html("");
		con2_a=0;
		li2="";
		MOVIL=[];
	}else{
  		$.each(data.cata,function(index,user){
  			var idmovil="";
  			enviarIdentificador(user.id_movil); //id unico del movil
  			//enviarPosicion(user.latitud,user.longitud,user.id_movil,user.nombre,user.numero);
  			enviarPuntos(user.latitud,user.longitud,user.id_movil,user.nombre,user.hora,user.fecha);
  			/*if(MOVIL.length==0){
  				MOVIL[MOVIL.length]=(user.id_movil);
  				//idmovil="'"+user.id_movil+"'";
  				//li+='<a href="javascript:Empleado('+idmovil+')"class="list-group-item"><img class="icon-line" src="img/online.png">'+user.nombre+'</a>';
  			}else{
				var aux=0;
  				for(var i = 0; i<MOVIL.length; i++) {
  					if(MOVIL[i]==user.id_movil){
  						aux++;
   					}
  				}
  				if(aux==0){
  					//idmovil="'"+user.id_movil+"'";
  					MOVIL[(MOVIL.length)+1]=(user.id_movil);
  					//li+="<a href='#' onclick='Empleado('"+user.id_movil+"'')' class='list-group-item'><img class='icon-line' src='img/online.png'>"+user.nombre+"</a>";
  				//li+='<a href="javascript:Empleado('+idmovil+')" class="list-group-item"><img class="icon-line" src="img/online.png">'+user.nombre+'</a>';

  				}
  			}*/
  		});
  			//console.log("Tamaño de Marca "+MARCADORES.length);
			li="", cont=0, MOVIL=[];


}
});

socket.on('monitorPrincipal',function(data){
  //console.log(data);
  var index=buscar(data);
  	if(index===-1){//ES NUEVO
		nuevoPosicion(data);
	}else{//REGISTRADO
		actualizarPosicion(index,data);
		//console.log("Tamanio "+ MARCADORES.length);
	}
});

function Empleado(cedula, nombre){
	if(cedula=="todos"){
     	MAP.setCenter({lat: -1.053201, lng: -80.456173});
     	MAP.setZoom(13);
    		graficar_todos_cortes();
    	MOVIL=[];		LATITUD = [];		LONGITUD =[];
		eliminarMarcadores();
		show_stack_bottomleft('info',nombre,"Se trazo la ruta del empleado");
		socket.emit("DatosEmpleados",cedula);
			$.ajax({url:"/puntos",type:"POST",data:{cedula:cedula},
				success:function(data){
					$(data).each(function(i, v){
						LATITUD.push(v.latitud);				LONGITUD.push(v.longitud);
					});
					var ruta = [];
					for (var i = 0; i<LONGITUD.length; i++) {
        				ruta.push(new google.maps.LatLng(LATITUD[i], LONGITUD[i]))
   					}
					if(lineas!=null){
			  				lineas.setMap(null);
					}
    		  		lineas = new google.maps.Polyline({
        				path: ruta,
         				map: MAP,
         				strokeColor: '#222000',
         				strokeWeight: 4,
         				strokeOpacity: 0.6,
         				clickable: false
    				});
				}
			});
	}else{
		graficar_cortes(cedula);
		MOVIL=[];
		LATITUD = [];
		LONGITUD =[];
		eliminarMarcadores();
		show_stack_bottomleft('info',nombre,"Se trazo la ruta del empleado");
		socket.emit("DatosEmpleados",cedula);
			$.ajax({url:"/puntos",	type:"POST",data:{cedula:cedula},
				success:function(data){
					$(data).each(function(i, v){
						LATITUD.push(v.latitud);	LONGITUD.push(v.longitud);
					});
					var ruta = [];
					for (var i = 0; i<LONGITUD.length; i++) {
        				ruta.push(new google.maps.LatLng(LATITUD[i], LONGITUD[i]))
   					}
					if(lineas!=null){
			  				lineas.setMap(null);
					}
    		  		lineas = new google.maps.Polyline({
        				path: ruta,
         				map: MAP,
         				strokeColor: '#222000',
         				strokeWeight: 4,
         				strokeOpacity: 0.6,
         				clickable: false
    				});
				}
			});
		}
}

function graficar_todos_cortes(){
	//console.log(CuadrillaArray.length);
  /* if(lineas_2!=null){
              lineas_2.setMap(null);
            }*/
	var n=CuadrillaArray.length;
	var mar_color;
	var num_tramites=0;
    $.ajax({
    	url:"/p_puntos_corte_todos",
		type:"GET",
		dataType:'json',
		success:function(res){
			elimar_marcador_cortes();
					$(res).each(function(i,v){
						for(var ii=0;ii<n;ii++){
      						if(CuadrillaArray[ii].cedula===v.desc_nom_notificador){
        							mar_color=CuadrillaArray[ii].mark;
        							if(v.tipo_trabajo=="C"){
										if(v.latitud== "" || v.longitud==""){

										}else{
											 var contentString = '<div id="content">'+
                                              '<div id="siteNotice">'+
                                              '</div><h5 id="titulo" style="text-align: center;">'+v.CLIENTE+'</h5>'+
                                              '<div id="bodyContent">'+
                                              '<p><b>Numero Cuenta:</b> '+v.numero_cuenta+'<br></p>'+
                                              '<p><b>Serie Medidor:</b> '+v.serie_medidor+'<br></p>'+
                                              '<p><b>Tramite:</b> '+v.id_tramite+'<br></p>'+
                                              '</div>'+
                                              '</div>';
                          					var infowindow = new google.maps.InfoWindow({
                              					content: contentString
                          					});

											if(v.sal_abil!=""){
												Utm_Gps(v.longitud, v.latitud,17,true);
				 									var uluru = {lat: gps_latitud, lng: gps_longitud};
				 									var marker= new google.maps.Marker({
          												position: uluru,
          												map: MAP,
          												title: v.id_tramite+"-"+v.nom_notificador+"Tramite ok",
          												icon: 'img/'+mar_color+'-1.png'
        											});
											}else if(v.sal_abil==""){
												Utm_Gps(v.longitud, v.latitud,17,true);
				 								var uluru = {lat: gps_latitud, lng: gps_longitud};
				 								var marker= new google.maps.Marker({
          											position: uluru,
          											map: MAP,
          											title: v.id_tramite+" - "+v.nom_notificador,
          											icon: 'img/'+mar_color+'.png'
        										});
				 							}
        									markers.push(marker);
				 							marker.addListener('click', function() {
                 								infowindow.close();
                								infowindow.open(MAP, marker);
              								});
				 							MAP.addListener('click', function(){
                  								infowindow.close();
                							});
										}
									}else if(v.tipo_trabajo=="R"){ //RECONEXION
										if(v.latitud== "" || v.longitud==""){

										}else{
											var contentString = '<div id="content">'+
                                              '<div id="siteNotice">'+
                                              '</div><h5 id="titulo" style="text-align: center;">'+v.CLIENTE+'</h5>'+
                                              '<div id="bodyContent">'+
                                              '<p><b>Numero Cuenta:</b> '+v.numero_cuenta+'<br></p>'+
                                              '<p><b>Serie Medidor:</b> '+v.serie_medidor+'<br></p>'+
                                              '<p><b>Tramite:</b> '+v.id_tramite+'<br></p>'+
                                              '</div>'+
                                              '</div>';
                          					var infowindow = new google.maps.InfoWindow({
                              					content: contentString
                          					});

											if(v.sal_abil!=""){
												Utm_Gps(v.longitud, v.latitud,17,true);
				 									var uluru = {lat: gps_latitud, lng: gps_longitud};
				 									var marker= new google.maps.Marker({
          												position: uluru,
          												map: MAP,
          												title: v.id_tramite+"-"+v.nom_notificador+"Tramite ok",
          												icon: 'img/'+mar_color+'-r-1.png'
        											});
											}else if(v.sal_abil==""){
												Utm_Gps(v.longitud, v.latitud,17,true);
				 								var uluru = {lat: gps_latitud, lng: gps_longitud};
				 								var marker= new google.maps.Marker({
          											position: uluru,
          											map: MAP,
          											title: v.id_tramite+" - "+v.nom_notificador,
          											icon: 'img/'+mar_color+'-r.png'
        										});
				 							}
        							markers.push(marker);
				 							marker.addListener('click', function() {
                 								infowindow.close();
                								infowindow.open(MAP, marker);
              								});
				 							 MAP.addListener('click', function(){
                  								infowindow.close();
                							});
										}

									}
      						}
					
   						}  MAP.setZoom(14);
   				});

		}
	});

}

function graficar_cortes(cedula){
	var n=CuadrillaArray.length;
	var mar_color;
	var num_tramites=0;

    for(var i=0;i<n;i++){
      if(CuadrillaArray[i].cedula===cedula){
        mar_color=CuadrillaArray[i].mark;
        break;
      }
    }   
    get_numero_telefono(cedula);  
    var LATI = [];
    var LONGI =[];
    var ruta_linea = [];

	$.ajax({
		url:"/p_puntos_corte",
		type:"POST",
		data:{cedula:cedula},
		success:function(res){
			elimar_marcador_cortes();
			var tramiteIi=0;
			var tramiteEe=0;
			$(res).each(function(i,v){
				if(v.tipo_trabajo=="C"){
        

				num_tramites=num_tramites+i;
				//console.log("Latitud"+v.latitud+" Logintud "+v.longitud);
				if(v.latitud!= "" || v.longitud !=""){
					var contentString = '<div id="content">'+
                                        '<div id="siteNotice">'+
                                        '</div><h5 id="titulo" style="text-align: center;">'+v.CLIENTE+'</h5>'+
                                        '<div id="bodyContent">'+
                                        '<p><b>Numero Cuenta:</b> '+v.numero_cuenta+'<br></p>'+
                                        '<p><b>Serie Medidor:</b> '+v.serie_medidor+'<br></p>'+
                                        '<p><b>Tramite:</b> '+v.id_tramite+'<br></p>'+
                                        '</div>'+
                                        '</div>';
                    var infowindow = new google.maps.InfoWindow({	content: contentString });

					if(v.sal_abil!=""){
            Utm_Gps(v.longitud, v.latitud,17,true);
				 		var uluru = {lat: gps_latitud, lng: gps_longitud};
				 		var marker= new google.maps.Marker({
          					position: uluru,
          					map: MAP,
          					title: v.nom_notificador,
          					icon: 'img/'+mar_color+'-1.png'
        				});
        				tramiteEe++;
					}else if(v.sal_abil==""){
					Utm_Gps(v.longitud, v.latitud,17,true);
          LATI.push({"latitud":gps_latitud,"longitud":gps_longitud}); //array de ruta 
				 		var uluru = {lat: gps_latitud, lng: gps_longitud};
				 		var marker= new google.maps.Marker({
          					position: uluru,
          					map: MAP,
          					title: v.nom_notificador,
          					icon: 'img/'+mar_color+'.png'
        				});
        				tramiteIi++;			
        	}
        			markers.push(marker);
        			marker.addListener('click', function() {
                 		infowindow.close();
                		infowindow.open(MAP, marker);
              		});
				 	    MAP.addListener('click', function(){
                  		infowindow.close();
                	});
        				MAP.setCenter(marker.getPosition());
        				MAP.setZoom(14);
        				$(".info-tramite").show();
        				$(".info-tramite").addClass('animated bounceInDown');
        				$("#nunTramite").html(markers.length);
        				$("#tramitesI").html(tramiteIi);
        				$("#tramitesE").html(tramiteEe);
      }
        }else if(v.tipo_trabajo=="R"){
        		num_tramites=num_tramites+i;
				//console.log("Latitud"+v.latitud+" Logintud "+v.longitud);
				  if(v.latitud != "" || v.longitud !=""){
					  var contentString = '<div id="content">'+
                                        '<div id="siteNotice">'+
                                        '</div><h5 id="titulo" style="text-align: center;">'+v.CLIENTE+'</h5>'+
                                        '<div id="bodyContent">'+
                                        '<p><b>Numero Cuenta:</b> '+v.numero_cuenta+'<br></p>'+
                                        '<p><b>Serie Medidor:</b> '+v.serie_medidor+'<br></p>'+
                                        '<p><b>Tramite:</b> '+v.id_tramite+'<br></p>'+
                                        '</div>'+
                                        '</div>';
            var infowindow = new google.maps.InfoWindow({	content: contentString });
					 if(v.sal_abil!=""){
						Utm_Gps(v.longitud, v.latitud,17,true);
				 		var uluru = {lat: gps_latitud, lng: gps_longitud};
				 		var marker= new google.maps.Marker({
          					position: uluru,
          					map: MAP,
          					title: v.nom_notificador,
          					icon: 'img/'+mar_color+'-r-1.png'
        				});
        				tramiteEe++;
					 }else if(v.sal_abil==""){
					    Utm_Gps(v.longitud, v.latitud,17,true);
              LATI.push({"latitud":gps_latitud,"longitud":gps_longitud}); //array de ruta 
				 		  var uluru = {lat: gps_latitud, lng: gps_longitud};
				 		  var marker= new google.maps.Marker({
          					position: uluru,
          					map: MAP,
          					title: v.nom_notificador,
          					icon: 'img/'+mar_color+'-r.png'
        				});
        				tramiteIi++;
        				
        	   }
        			markers.push(marker);
        			marker.addListener('click', function() {
                 		infowindow.close();
                		infowindow.open(MAP, marker);
              		});
				 	    MAP.addListener('click', function(){
                  		infowindow.close();
                	});
        				MAP.setCenter(marker.getPosition());
        				MAP.setZoom(14);
        				$(".info-tramite").show();
        				$(".info-tramite").addClass('animated bounceInDown');
        				$("#nunTramite").html(markers.length);
        				$("#tramitesI").html(tramiteIi);
        				$("#tramitesE").html(tramiteEe);
        }
        		
      }
			}); // FIN DEL FOREACH
          /*  if(lineas_2!=null){
              lineas_2.setMap(null);
            }
            //lat.sort(function(a,b) {return (a.latitud > b.latitud) ? 1 : ((b.longitud > a.longitud) ? -1 : 0);});
          //long_.sort(function(a, b){return a-b});
           //debugger
            for (var i = 0; i<LATI.length; i++) {
                ruta_linea.push(new google.maps.LatLng(LATI[i].latitud, LATI[i].longitud))
            }

          var lineSymbol = {
              path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW
              };
        var symbolThree = {
          path: 'M -2,-2 2,2 M 2,-2 -2,2',
          strokeColor: '#292',
          strokeWeight: 4
        };
        var symbolOne = {
          path: 'M -2,0 0,-2 2,0 0,2 z',
          strokeColor: '#F00',
          fillColor: '#F00',
          fillOpacity: 1
        };*/
             /* lineas_2 = new google.maps.Polyline({
                path: ruta_linea,
                map: MAP,
                icons: [{
                        icon: symbolThree,
                        offset: '0%'  
                        },
                        {
                        icon: symbolOne,
                        offset: '100%'
                        }],
                strokeColor: '#00BFFF',*/
                /*strokeWeight: 4,
                strokeOpacity: 0.6,
                clickable: false
            });*/
		}
	});
}

function get_numero_telefono(cedula){
	$.ajax({
		url: "/cuadrilla_telefono",
		type:"POST",
		dataType:'json',
		data:{cedula:cedula},
		success:function(resul){
			$(resul).each(function(i,v){
				numero_telefono="";
				numero_telefono=v.numero;
        		$("#telefono").html(numero_telefono);
			});


		}
	});
}

function elimar_marcador_cortes(){
	$(".info-tramite").hide();
	if(markers!=null){
		for (var i = 0; i < markers.length; i++) {
			debugger
			markers[i].setMap(null);
		}
		markers=[];
	}
}

function buscar_cuadrilla(data){
    var index=-1;   
    var n=CuadrillaArray.length;
    for(var i=0;i<n;i++){
      if(CuadrillaArray[i].cedula===data){
        index=i;
        break;
      }
    }     
    return index;     
} 

function buscar_tramites(data){
    var index=-1;   
    var n=TramitesArray.length;
    for(var i=0;i<n;i++){
      if(TramitesArray[i].id_movimiento===data){
        index=i;
        break;
      }
    }     
    return index;     
} 

function Utm_Gps(cord_X, cord_Y, cord_zona, southhemi){// function cmdUTM2Lat_click(){
  latlon = new Array(2);
  var x, y, zone, southhemi;
  //var zona = cord_zona.value;
  var zona = cord_zona;

  if (isNaN (parseFloat (cord_X))) {
    alert ("Por favor ingrese un valor valido para X.");
    return false;
  }

  x = parseFloat (cord_X);
  if (isNaN (parseFloat (cord_Y))) {
    alert ("Por favor ingrese un valor valido para Y.");
    return false;
  }

  y = parseFloat (cord_Y);
  if (isNaN (parseInt (zona))) {
    alert ("Por favor ingrese una zona valida de UTM.");
    return false;
  }

  zone = parseFloat (zona);
  if ((zone < 1) || (60 < zone)) {
    alert ("El valor de zona de UTM esta fuera de rango. Por favor ingrese un valor entre [1, 60].");
    return false;
  }

  UTMXYToLatLon (x, y, zone, southhemi, latlon);
  
  // Coordenadas GPS
  gps_longitud = RadToDeg (latlon[1]);
  gps_latitud = RadToDeg (latlon[0]);
  //$('TXT_URM_X').value = x;
  //$('TXT_URM_Y').value = y;
  //document.frmConverter.txtLon.value = RadToDeg (latlon[1]);
  //document.frmConverter.txtLat.value = RadToDeg (latlon[0]);
};

function initMap(){
        MAP=new google.maps.Map(document.getElementById('map'), {
          center: {lat: -1.053201, lng: -80.456173}, 
          scrollwheel: false,
          zoom: 14,
          gestureHandling: 'auto'
        });
}
/////////////////////////////////////////////////////////////////////////////

function colores(){
	$.ajax({
		url:"colores",
		type:'GET',
		dataType:'json',
		success:function(res){
			$(res).each(function(i,v){
				colorArray.push({color:v.color});
			});
		}
	});
}
/////////////////////////////////////////////////////////////////////////////
function buscar(data){
		var index=-1;		
		var n=MARCADORES.length;
		for(var i=0;i<n;i++){
			if(MARCADORES[i].getId()==data.id){
				index=i;
				break;
			}
		}			
		return index;			
}	

function buscar_idmovil(data){
	var index=-1;		
	var n=MARCADORES.length;
		for(var i=0;i<n;i++){
			if(MARCADORES[i].getNombre()==data){
				index=i;
				break;
			}
		}			
		return index;			
}	

function nuevoPosicion(data){
	var marca=new cMarker(MAP,data.id,data.lat,data.lon,data.hora,data.fecha);
	marca.dibujar();
	MARCADORES.push(marca);//agregamos al ARRAY
}

function actualizarPosicion(index,data){
	var marca=MARCADORES[index];
	marca.remover();	
	marca.update(data.lat,data.lon,data.hora,data.fecha);
	marca.dibujar();
}

function removerPosicion(index){
	var marca=MARCADORES[index];
	marca.remover();
	MARCADORES.splice(index, 1);//eliminamos del ARRAY	
}

function eliminarMarcadores(){
	var n=MARCADORES.length;
		for(var i=0;i<n;i++){
			MARCADORES[i].remover();
		}
		MARCADORES=[];
}

function enviarPuntos(lat,long,cedula,nombre,numero,hora,fecha){
	var data={};
		data.lat=lat;
		data.lon=long;
		data.hora=hora;
    data.fecha=fecha;
		socket.emit("posicionClientes",data);
}

/*function enviarPosicion(lat,long,cedula,nombre,numero){
		var data={};
		data.lat=lat
		data.lon=long
		data.id=cedula;
		data.nombre=nombre;
		data.numero=numero;
		socket.emit("posicionClientes",data);
}*/
////////////////////////////////////

function enviarIdentificador(id_movil){
		var data={};
		data.id=id_movil;
		socket.emit("loginCliente",data,function(data){//{estado,id}
				if(data.estado===0){
					//alert("Existe otro usuario con el Identificador");
					//console.log("El usuario ya se encuentra registrado")
				}
				else{
					_ID=data.id;
					//alert(_ID);
					//console.log("ID "+_ID);
					//document.getElementById("idSocket").innerHTML=ID;
					//document.getElementById("idFormulario2").style.display="block";//MOSTRAMOS FORM2
					//document.getElementById("idFormulario1").style.display="none";//OCULTAMOS FORM1
				}
		});
	}

function show_stack_bottomleft(type,nombre,texto) {
    var opts = {
        title: "Over Here",
        text: "Check me out. I'm in a different stack.",
        addclass: "stack-bottomleft",
        stack: stack_bottomleft
    };
    switch (type) {
    case 'error':
        opts.title = "Oh No";
        opts.text = "Watch out for that water tower!";
        opts.type = "error";
        break;
    case 'info':
        opts.title = nombre;
        opts.text = texto;
        opts.type = "info";
        break;
    case 'success':
        opts.title = "Good News Everyone";
        opts.text = "I've invented a device that bites shiny metal asses.";
        opts.type = "success";
        break;
    }
    new PNotify(opts);
}

function notificar_tramite2(titulo, mensaje, foto){
	PNotify.desktop.permission();
	(new PNotify({
    title: titulo,
    text: mensaje,
    desktop: {
        desktop: true,
        icon: '/img/portoaguas.jpg'
    }
})).get().click(function(e) {
    if ($('.ui-pnotify-closer, .ui-pnotify-sticker, .ui-pnotify-closer *, .ui-pnotify-sticker *').is(e.target)) return;
    //alert('Hey! You clicked the desktop notification!');
    abrirEnPestana(foto);
});
}
function notificar_tramite(titulo, mensaje){
	PNotify.desktop.permission();
	(new PNotify({
    title: titulo,
    text: mensaje,
    desktop: {
        desktop: true,
        icon: '/img/portoaguas.jpg'
    }
})).get().click(function(e) {
    if ($('.ui-pnotify-closer, .ui-pnotify-sticker, .ui-pnotify-closer *, .ui-pnotify-sticker *').is(e.target)) return;
    //alert('Hey! You clicked the desktop notification!');
    //abrirEnPestana(foto);
});
}

function abrirEnPestana(url) {
		var a = document.createElement("a");
		a.target = "_blank";
		a.href = url;
		a.click();
	}
 
	//var url="http://www.lawebdelprogramador.com";
 
	/*window.onload=function(){
		
	}*/


 /*function getIPs(callback){
        var ip_dups = {};
    
        //compatibilidad exclusiva de firefox y chrome, el usuario @guzgarcia compartio este enlace muy util: http://iswebrtcreadyyet.com/
        var RTCPeerConnection = window.RTCPeerConnection
            || window.mozRTCPeerConnection
            || window.webkitRTCPeerConnection;
        var useWebKit = !!window.webkitRTCPeerConnection;
    
        //bypass naive webrtc blocking using an iframe
        if(!RTCPeerConnection){
            //NOTE: necesitas tener un iframe in la pagina, exactamente arriba de la etiqueta script
            //
            //<iframe id="iframe" sandbox="allow-same-origin" style="display: none"></iframe>
            //<script>... se llama a la funcion getIPs aqui...
            //
            var win = iframe.contentWindow;
            RTCPeerConnection = win.RTCPeerConnection
                || win.mozRTCPeerConnection
                || win.webkitRTCPeerConnection;
            useWebKit = !!win.webkitRTCPeerConnection;
        }
    
        //requisitos minimos para conexion de datos
        var mediaConstraints = {
            optional: [{RtpDataChannels: true}]
        };
    
        var servers = {iceServers: [{urls: "stun:stun.services.mozilla.com"}]};
    
        //construccion de una nueva RTCPeerConnection
        var pc = new RTCPeerConnection(servers, mediaConstraints);
    
        function handleCandidate(candidate){
            // coincidimos con la direccion IP
            var ip_regex = /([0-9]{1,3}(\.[0-9]{1,3}){3}|[a-f0-9]{1,4}(:[a-f0-9]{1,4}){7})/
            var ip_addr = ip_regex.exec(candidate)[1];
    
            //eliminamos duplicados
            if(ip_dups[ip_addr] === undefined)
                callback(ip_addr);
    
            ip_dups[ip_addr] = true;
        }
    
        //escuchamos eventos candidatos
        pc.onicecandidate = function(ice){
    
            //dejamos de lado a los eventos que no son candidatos
            if(ice.candidate)
                handleCandidate(ice.candidate.candidate);
        };
    
        //creamos el canal de datos
        pc.createDataChannel("");
    
        //creamos un offer sdp
        pc.createOffer(function(result){
    
            //disparamos la peticion (request) al stun server (para entender mejor debemos ver la documentacion de WebRTC.
            pc.setLocalDescription(result, function(){}, function(){});
    
        }, function(){});
    
        //esperamos un rato para dejar que todo se complete:
        setTimeout(function(){
            //leemos la informacion del candidato desde la descripcion local
            var lines = pc.localDescription.sdp.split('\n');
    
            lines.forEach(function(line){
                if(line.indexOf('a=candidate:') === 0)
                    handleCandidate(line);
            });
        }, 1000);
    }*/